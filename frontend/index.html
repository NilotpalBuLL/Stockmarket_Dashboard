
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JarNox — Stock Market Dashboard</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b1220; color:#e6edf3; }
    header { padding: 16px 20px; border-bottom: 1px solid #263043; display:flex; align-items:center; gap:12px; }
    header h1 { font-size: 18px; margin: 0; }
    .container { display: grid; grid-template-columns: 280px 1fr; height: calc(100vh - 64px); }
    aside { border-right: 1px solid #263043; overflow-y: auto; padding: 12px; }
    aside input { width: 100%; padding: 8px 10px; border-radius: 10px; border:1px solid #2a3756; background:#0f172a; color:#e6edf3; margin-bottom: 10px; }
    .company { padding: 10px 12px; border-radius: 12px; cursor: pointer; border:1px solid transparent; }
    .company:hover { background:#111a2f; }
    .company.active { background:#0f1b35; border-color:#29477c; }
    main { padding: 14px; display:flex; flex-direction: column; gap: 12px;}
    .cards { display:grid; grid-template-columns: repeat(4, minmax(160px,1fr)); gap:12px; }
    .card { background:#0f172a; border:1px solid #223052; padding:14px; border-radius:16px; }
    .card h3 { margin:0 0 8px 0; font-size:12px; color:#9fb0cf; font-weight:600; letter-spacing:.3px;}
    .card .value { font-weight:700; font-size:20px; }
    #chart-wrap { background:#0f172a; border:1px solid #223052; border-radius:16px; padding:12px; }
    footer { padding: 10px 16px; border-top: 1px solid #263043; font-size: 12px; color:#90a4c7;}
    .badge { font-size: 11px; padding: 2px 8px; background:#13213c; border:1px solid #29477c; border-radius:999px; }
    .row { display:flex; align-items:center; justify-content: space-between; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
  
    <h1>Stock Market Dashboard</h1>
  </header>
  <div class="container">
    <aside>
      <input id="search" placeholder="Search company..." />
      <div id="list"></div>
    </aside>
    <main>
      <div class="row">
        <div style="display:flex; gap:10px; align-items:center;">
          <h2 id="title" style="margin:0;font-size:18px;">Select a company</h2>
          <span id="subtitle" class="badge"></span>
        </div>
      </div>
      <div class="cards">
        <div class="card"><h3>Last Close</h3><div class="value" id="lastClose">—</div></div>
        <div class="card"><h3>52W High</h3><div class="value" id="hi52">—</div></div>
        <div class="card"><h3>52W Low</h3><div class="value" id="lo52">—</div></div>
        <div class="card"><h3>Avg Vol (30d)</h3><div class="value" id="avgVol">—</div></div>
      </div>
      <div id="chart-wrap">
        <canvas id="priceChart" height="120"></canvas>
      </div>
      <div class="card">
        <div class="row">
          <h3 style="margin:0;">AI Prediction (Next Close)</h3>
          <div class="value" id="pred">—</div>
        </div>
      </div>
    </main>
  </div>
  

  <script>
    const API_BASE = "http://localhost:8000";
    let currentSymbol = null;
    let chart = null;
    const fmt = (n) => (n == null || isNaN(n) ? "—" : new Intl.NumberFormat('en-IN', {maximumFractionDigits:2}).format(n));
    const fmtVol = (n) => (n == null ? "—" : new Intl.NumberFormat('en-IN').format(Math.round(n)));

    async function fetchJSON(path){
      const r = await fetch(API_BASE + path);
      if(!r.ok) throw new Error("Network error");
      return r.json();
    }

    function renderList(items){
      const q = document.getElementById("search").value.toLowerCase();
      const list = document.getElementById("list");
      list.innerHTML = "";
      items.filter(it => it.name.toLowerCase().includes(q) || it.symbol.toLowerCase().includes(q))
        .forEach(it => {
          const div = document.createElement("div");
          div.className = "company" + (currentSymbol === it.symbol ? " active" : "");
          div.textContent = it.name + " (" + it.symbol + ")";
          div.onclick = () => selectCompany(it.symbol, it.name);
          list.appendChild(div);
        });
    }

    async function selectCompany(symbol, name){
      currentSymbol = symbol;
      document.getElementById("title").textContent = name + " (" + symbol + ")";
      document.getElementById("subtitle").textContent = "Mock historical data";
      // Metrics
      const metrics = await fetchJSON(`/api/metrics?symbol=${symbol}`);
      document.getElementById("lastClose").textContent = fmt(metrics.last_close);
      document.getElementById("hi52").textContent = fmt(metrics.hi_52w);
      document.getElementById("lo52").textContent = fmt(metrics.lo_52w);
      document.getElementById("avgVol").textContent = fmtVol(metrics.avg_volume_30d);
      document.getElementById("pred").textContent = fmt(metrics.forecast_next_close);

      const hist = await fetchJSON(`/api/history?symbol=${symbol}`);
      const labels = hist.history.map(d => d.date);
      const closes = hist.history.map(d => d.close);

      // 20-day SMA on client for visualization
      const sma20 = [];
      for(let i=0;i<closes.length;i++){
        if(i<19){ sma20.push(null); }
        else {
          let s=0; for(let j=i-19;j<=i;j++) s += closes[j];
          sma20.push(s/20);
        }
      }

      if(chart){ chart.destroy(); }
      const ctx = document.getElementById("priceChart").getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Close",
            data: closes,
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.2
          },{
            label: "SMA 20",
            data: sma20,
            borderWidth: 2,
            borderDash: [6,4],
            pointRadius: 0,
            tension: 0.2
          }]
        },
        options: {
          plugins: {
            legend: { labels: { color: "#c9d5f0" } },
            tooltip: { mode: "index", intersect: false }
          },
          scales: {
            x: { ticks: { color:"#9fb0cf", maxRotation:0, autoSkip: true }, grid: { color:"#14203b" } },
            y: { ticks: { color:"#9fb0cf" }, grid: { color:"#14203b" } }
          }
        }
      });

      // refresh active state
      document.querySelectorAll(".company").forEach(el => el.classList.remove("active"));
      [...document.querySelectorAll(".company")].find(el => el.textContent.includes("(" + symbol + ")"))?.classList.add("active");
    }

    async function init(){
      try {
        const resp = await fetchJSON("/api/companies");
        window._companies = resp.companies;
        renderList(resp.companies);
        if(resp.companies.length) selectCompany(resp.companies[0].symbol, resp.companies[0].name);
      } catch (e) {
        alert("Start the backend first: `uvicorn main:app` in the backend folder");
      }
      document.getElementById("search").addEventListener("input", () => renderList(window._companies || []));
    }
    init();
  </script>
</body>
</html>
